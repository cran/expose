<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Ibon Tamayo-Uria, Youssef Oulhote &amp; Marie-Abèle Bind" />

<meta name="date" content="2019-05-14" />

<title>Multiple effect estimation of chemicals in Environmental Epidemiology</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Multiple effect estimation of chemicals in Environmental Epidemiology</h1>
<h4 class="author">Ibon Tamayo-Uria, Youssef Oulhote &amp; Marie-Abèle Bind</h4>
<h4 class="date">2019-05-14</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Although the general population is exposed to multiple chemicals, most environmental epidemiology studies consider each chemical separately when estimating the adverse effects of environmental exposures, partly because of the lack of software accessible to environmental epidemiologists.</p>
</div>
<div id="objective" class="section level1">
<h1>Objective:</h1>
<p>We developed a statistical R package, accessible to environmental health scientists that can provide valid estimates for effects of environmental contaminants, dose-response relationships, and interactions in a multi-pollutant setting.</p>
</div>
<div id="methods" class="section level1">
<h1>Methods:</h1>
<p>This package implements the work of Oulhote et al (2017) that combines the G-formula, a maximum likelihood estimator, with the ensemble learning technique Super Learner. It incorporates a wide range of statistical techniques (e.g. generalized linear and additive models, random forest, extreme gradient boosting) to estimate and provide valid inference in multi-pollutant settings and reconstruct dose-response relationships non-parametrically.</p>
</div>
<div id="results" class="section level1">
<h1>Results:</h1>
<p>This package will facilitate multi-pollutant analysis of environmental epidemiology. We also developed a user-friendly Shiny application that can be used by biomedical researchers modeling complex mixtures. We ran multiple simulations based on real scenarios and the proposed method yielded promising results across all the scenarios. Our approach was also able to estimate the true underlying structure of the data. We will present a tutorial describing the package functions and visualizations to illustrate our developed methods.</p>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion:</h1>
<p>This package will help to unravel the effects of chemical mixtures and their interactions in epidemiological studies.</p>
</div>
<div id="reference" class="section level1">
<h1>Reference:</h1>
<p>Youssef Oulhote, Marie-Abele Bind, Brent Coull, Chirag, Patel, Philippe Grandjean. 2017. Combining Ensemble Learning Techniques and G-Computation to Investigate Chemical Mixtures in Environmental Epidemiology Studies. Biorxiv. <a href="https://www.biorxiv.org/content/early/2017/06/30/147413.article-info" class="uri">https://www.biorxiv.org/content/early/2017/06/30/147413.article-info</a></p>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>You can install the released version of expose from www.github.com with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
 devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;itamuria/expose&quot;</span>)</code></pre></div>
</div>
<div id="case-study" class="section level2">
<h2>Case study</h2>
<p>This is a basic case study similar to the analysed on the paper.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>())
time_doc1 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()


<span class="kw">library</span>(expose)

<span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;pacman&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)
<span class="kw">library</span>(pacman)
pacman<span class="op">::</span><span class="kw">p_load</span>(ggplot2, repmis,RColorBrewer,SuperLearner, gam,splines,foreach,glmnet,Matrix,nnet,polspline,e1071,xgboost)


<span class="co"># Download data</span>
<span class="kw">source_data</span>(<span class="st">&quot;https://github.com/itamuria/expose_dataset/blob/master/20180818_dtaset.RData?raw=true&quot;</span>)
<span class="kw">set.seed</span>(<span class="dv">22222</span>)

<span class="co"># Define parameters</span>

N &lt;-<span class="st"> </span><span class="kw">dim</span>(dtaset)[<span class="dv">1</span>]
seku &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.05</span>)   <span class="co">#c(0,0.1,0.2,0.25,0.3,0.4,0.5,0.6,0.7,0.75,0.8,0.9,1)</span>
our.num.sim &lt;-<span class="st"> </span><span class="dv">5</span>
delta=<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)


Exposures&lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Var1&quot;</span>,<span class="st">&quot;Var2&quot;</span>,<span class="st">&quot;Var3&quot;</span>,<span class="st">&quot;Var4&quot;</span>,<span class="st">&quot;Var5&quot;</span>)
Confounders&lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>)


###############################################################################################################
<span class="co"># Crossvalidation</span>
###############################################################################################################

ourlibraries &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SL.glm&quot;</span>, <span class="st">&quot;SL.glm.interaction&quot;</span>,<span class="st">&quot;SL.glmnet&quot;</span>, <span class="st">&quot;SL.gam&quot;</span>,<span class="st">&quot;SL.nnet&quot;</span>,
                  <span class="st">&quot;SL.polymars&quot;</span>,<span class="st">&quot;SL.svm&quot;</span>,<span class="st">&quot;SL.xgboost&quot;</span>)




Outcome <span class="dv">4</span>
Outcome &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Y4&quot;</span>)
m4 &lt;-<span class="st"> </span>SuperLearner<span class="op">::</span><span class="kw">CV.SuperLearner</span>(<span class="dt">Y =</span> dtaset[,Outcome[<span class="dv">1</span>]],
                                   <span class="dt">X =</span> dtaset[, <span class="kw">c</span>(Confounders,Exposures)],<span class="dt">V=</span><span class="dv">10</span>, <span class="dt">SL.library =</span> ourlibraries,
                                   <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;method.NNLS&quot;</span>,
                                   <span class="dt">verbose =</span> <span class="ot">FALSE</span>)

mm &lt;-<span class="st"> </span>m4<span class="op">$</span>AllSL[[<span class="dv">1</span>]]

###############################################################################################################
<span class="co"># create basic data frame</span>
###############################################################################################################

Outcome &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Y4&quot;</span>)

gen &lt;-<span class="st"> </span><span class="kw">general_function</span> (<span class="dt">dataset =</span> dtaset, <span class="dt">exposures =</span> Exposures,
                         <span class="dt">confounders =</span> Confounders,
                         <span class="dt">outcomes =</span> Outcome[<span class="dv">1</span>], <span class="dt">delta=</span>delta, <span class="dt">dr =</span> seku)


summary_table_lines &lt;-<span class="st"> </span>gen[[<span class="dv">2</span>]]



###############################################################################################################
<span class="co"># Simulations</span>
###############################################################################################################

t1 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
simu &lt;-<span class="st"> </span><span class="kw">run_simulations</span> (<span class="dt">dataset =</span> dtaset, <span class="dt">exposures =</span> Exposures,
                          <span class="dt">confounders =</span> Confounders, <span class="dt">libraries =</span> ourlibraries,
                          <span class="dt">outcomes =</span> Outcome[<span class="dv">1</span>], <span class="dt">num.sim =</span> our.num.sim, <span class="dt">delta=</span>delta, <span class="dt">dr =</span> seku,
                          <span class="dt">newdata =</span>gen[[<span class="dv">1</span>]], <span class="dt">show_times =</span> <span class="ot">TRUE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">save_time =</span> <span class="ot">TRUE</span>,
                         <span class="dt">show_num_sim =</span> <span class="ot">TRUE</span>, <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">method =</span><span class="st">&quot;method.NNLS&quot;</span>)

t2 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
(t2<span class="op">-</span>t1)

h &lt;-<span class="st"> </span><span class="dv">4</span>

###############################################################################################################
<span class="co"># Sensibility analysis</span>
###############################################################################################################


################################# risk

ris &lt;-<span class="st"> </span>simu[[<span class="dv">2</span>]]

len_sim &lt;-<span class="st"> </span><span class="kw">dim</span>(ris)[<span class="dv">2</span>]

lib &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;SL.&quot;</span>,<span class="st">&quot;&quot;</span>,ris<span class="op">$</span>libraries)
len_lib &lt;-<span class="st"> </span><span class="kw">length</span>(lib)

df1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">names</span>(df1) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Library&quot;</span>,<span class="st">&quot;Value&quot;</span>)

<span class="cf">for</span>(li <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>len_lib)
{
  df2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rep</span>(lib[li],len_sim<span class="op">-</span><span class="dv">1</span>),<span class="kw">t</span>(ris[li,<span class="dv">2</span><span class="op">:</span>len_sim]))
  <span class="kw">names</span>(df2) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Library&quot;</span>,<span class="st">&quot;Value&quot;</span>)
  df1 &lt;-<span class="st"> </span><span class="kw">rbind</span>(df1,df2)
}
df1 &lt;-<span class="st"> </span>df1[<span class="op">-</span><span class="dv">1</span>,]

<span class="kw">ggplot</span>(df1, <span class="kw">aes</span>(<span class="dt">x =</span> Library, <span class="dt">y =</span> Value, <span class="dt">fill =</span> Library)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()  <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Risk per method (minimize)&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>)

<span class="co"># name to save</span>
file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_Risk.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)
<span class="co">#unlink(file_exp_name)</span>


ris_table &lt;-<span class="st"> </span><span class="kw">data.frame</span>(lib,<span class="kw">apply</span>(ris[,<span class="op">-</span><span class="dv">1</span>],<span class="dv">1</span>,mean))
<span class="kw">names</span>(ris_table)&lt;-<span class="kw">c</span>(<span class="st">&quot;Library&quot;</span>,<span class="st">&quot;Performance&quot;</span>)
knitr<span class="op">::</span><span class="kw">kable</span>(ris_table)


################################# Coefficient

coef &lt;-<span class="st"> </span>simu[[<span class="dv">3</span>]]

coef_table &lt;-<span class="st"> </span><span class="kw">data.frame</span>(lib,<span class="kw">apply</span>(coef[,<span class="op">-</span><span class="dv">1</span>],<span class="dv">1</span>,mean))
<span class="kw">names</span>(coef_table)&lt;-<span class="kw">c</span>(<span class="st">&quot;Library&quot;</span>,<span class="st">&quot;Estimates&quot;</span>)
knitr<span class="op">::</span><span class="kw">kable</span>(coef_table)

df1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">names</span>(df1) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Library&quot;</span>,<span class="st">&quot;Value&quot;</span>)

<span class="cf">for</span>(li <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>len_lib)
{
  df2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rep</span>(lib[li],len_sim<span class="op">-</span><span class="dv">1</span>),<span class="kw">t</span>(coef[li,<span class="dv">2</span><span class="op">:</span>len_sim]))
  <span class="kw">names</span>(df2) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Library&quot;</span>,<span class="st">&quot;Value&quot;</span>)
  df1 &lt;-<span class="st"> </span><span class="kw">rbind</span>(df1,df2)
}
df1 &lt;-<span class="st"> </span>df1[<span class="op">-</span><span class="dv">1</span>,]

<span class="kw">ggplot</span>(df1, <span class="kw">aes</span>(<span class="dt">x =</span> Library, <span class="dt">y =</span> Value, <span class="dt">fill =</span> Library)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Coefficient per method (weight)&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) 

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_Coefficient.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)


###############################################################################################################
<span class="co"># Naive ACE: Average causal effect</span>
###############################################################################################################


ace.df.g &lt;-<span class="st"> </span><span class="kw">naive_ace</span> (<span class="dt">allsim =</span> simu[[<span class="dv">1</span>]], <span class="dt">dataset =</span> dtaset, <span class="dt">ic_dis =</span> <span class="st">&quot;IC&quot;</span>, <span class="dt">st =</span> summary_table_lines,
                       <span class="dt">exposures =</span> Exposures, <span class="dt">delta =</span> delta)

knitr<span class="op">::</span><span class="kw">kable</span>(ace.df.g)

<span class="co"># Use 95% confidence interval instead of SEM</span>
pd &lt;-<span class="st"> </span><span class="kw">position_dodge</span>(<span class="fl">0.1</span>)
<span class="kw">ggplot</span>(ace.df.g, <span class="kw">aes</span>(<span class="dt">x=</span>Group, <span class="dt">y=</span>Mean, <span class="dt">colour=</span>Group)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin=</span>ICa, <span class="dt">ymax=</span>ICb), <span class="dt">width=</span>.<span class="dv">1</span>, <span class="dt">position=</span>pd) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">position=</span>pd) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">position=</span>pd) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Estimated (Boostrapped 95% CI&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Library&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>)<span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Average Treatment Effect&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>)


file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_NaiveAce.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)

###############################################################################################################
<span class="co"># Dose Response</span>
###############################################################################################################


drr.grp &lt;-<span class="st"> </span><span class="kw">dose_resp</span> (<span class="dt">allsim =</span> simu[[<span class="dv">1</span>]], <span class="dt">dataset =</span> dtaset, <span class="dt">st =</span> summary_table_lines,
                     <span class="dt">dr =</span> seku, <span class="dt">exposures =</span> Exposures) 

knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(drr.grp))
drr.grp<span class="op">$</span>dose &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;DR_&quot;</span>,<span class="st">&quot;&quot;</span>,drr.grp<span class="op">$</span>Quantile))

pd &lt;-<span class="st"> </span><span class="kw">position_dodge</span>(<span class="fl">0.1</span>)

<span class="kw">ggplot</span>(drr.grp, <span class="kw">aes</span>(<span class="dt">x=</span>dose, <span class="dt">y=</span>Mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin=</span>Mean<span class="op">-</span>SE, <span class="dt">ymax=</span>Mean<span class="op">+</span>SE), <span class="dt">width=</span>.<span class="dv">025</span>, <span class="dt">position=</span>pd, <span class="dt">size=</span><span class="fl">0.5</span>, <span class="dt">color=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">position=</span>pd,<span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">position=</span>pd, <span class="dt">size=</span><span class="dv">2</span>, <span class="dt">shape=</span><span class="dv">20</span>, <span class="dt">fill=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(Exp <span class="op">~</span><span class="st"> </span>., <span class="dt">scales=</span><span class="st">&quot;free&quot;</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Dose response&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_DoseResponse1.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)

<span class="kw">ggplot</span>(drr.grp, <span class="kw">aes</span>(<span class="dt">x=</span>dose, <span class="dt">y=</span>Mean)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin=</span>Mean<span class="op">-</span>SE, <span class="dt">ymax=</span>Mean<span class="op">+</span>SE), <span class="dt">width=</span>.<span class="dv">05</span>, <span class="dt">position=</span>pd, <span class="dt">size=</span><span class="fl">0.5</span>, <span class="dt">color=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">position=</span>pd,<span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">position=</span>pd, <span class="dt">size=</span><span class="dv">2</span>, <span class="dt">shape=</span><span class="dv">20</span>, <span class="dt">fill=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(Exp <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st">  </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Dose response&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>()

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_DoseResponse2.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)


###############################################################################################################
<span class="co"># ice: individual conditional expectation</span>
###############################################################################################################

ice_res &lt;-<span class="st"> </span><span class="kw">ice</span>(<span class="dt">allsim =</span> simu[[<span class="dv">1</span>]], <span class="dt">dataset =</span> dtaset, <span class="dt">dr =</span> seku, <span class="dt">squem =</span> summary_table_lines, <span class="dt">remove_extrem =</span> <span class="ot">FALSE</span>)

<span class="co"># ploting</span>
p=<span class="kw">ggplot</span>(ice_res,<span class="kw">aes</span>(X, Var1_pred,<span class="dt">group=</span>id))
p<span class="op">+</span><span class="kw">geom_line</span>()<span class="op">+</span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="kw">sort</span>(<span class="kw">unique</span>(ice_res<span class="op">$</span>X)),
                   <span class="dt">labels=</span><span class="kw">as.character</span>(seku))

<span class="co"># name to save</span>
file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_ICE_1.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)

<span class="co"># coloring </span>
p=<span class="kw">ggplot</span>(ice_res,<span class="kw">aes</span>(X, Var2_pred,<span class="dt">group=</span>id, <span class="dt">color=</span>Var3)) 
p<span class="op">+</span><span class="kw">geom_line</span>()<span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Individual effect&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="kw">sort</span>(<span class="kw">unique</span>(ice_res<span class="op">$</span>X)),
                   <span class="dt">labels=</span><span class="kw">as.character</span>(seku))

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_ICE_2.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)

p=<span class="kw">ggplot</span>(ice_res,<span class="kw">aes</span>(X, Var1_pred,<span class="dt">group=</span>id,<span class="dt">col=</span>Var3)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&quot;Var1 percentiles&quot;</span>,<span class="dt">y=</span><span class="st">&quot;Predicted Y&quot;</span>)
p<span class="op">+</span><span class="kw">geom_line</span>()<span class="op">+</span><span class="kw">theme_bw</span>()<span class="op">+</span><span class="kw">scale_color_gradientn</span>(<span class="dt">name=</span><span class="st">&quot;Var3&quot;</span>,<span class="dt">colours=</span><span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dv">9</span>,<span class="st">&quot;YlOrRd&quot;</span>))) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="kw">sort</span>(<span class="kw">unique</span>(ice_res<span class="op">$</span>X)),
                   <span class="dt">labels=</span><span class="kw">as.character</span>(seku)) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Individual effect&quot;</span>)

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_ICE_3.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)


p=<span class="kw">ggplot</span>(ice_res,<span class="kw">aes</span>(X, Var3_pred,<span class="dt">group=</span>id,<span class="dt">col=</span>Var5)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&quot;Var3 percentiles&quot;</span>,<span class="dt">y=</span><span class="st">&quot;Predicted Y&quot;</span>)
p<span class="op">+</span><span class="kw">geom_line</span>()<span class="op">+</span><span class="kw">theme_bw</span>()<span class="op">+</span><span class="kw">scale_color_gradientn</span>(<span class="dt">name=</span><span class="st">&quot;Var5&quot;</span>,<span class="dt">colours=</span><span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dv">9</span>,<span class="st">&quot;YlOrRd&quot;</span>))) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="kw">sort</span>(<span class="kw">unique</span>(ice_res<span class="op">$</span>X)),
                   <span class="dt">labels=</span><span class="kw">as.character</span>(seku)) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Individual effect&quot;</span>)

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_ICE_4.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)

<span class="co"># discrete variables</span>

p=<span class="kw">ggplot</span>(ice_res,<span class="kw">aes</span>(X, Var3_pred,<span class="dt">group=</span>id,<span class="dt">col=</span>sex)) <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">&quot;pp-Var3 percentiles&quot;</span>,<span class="dt">y=</span><span class="st">&quot;Predicted Y&quot;</span>)
p<span class="op">+</span><span class="kw">geom_line</span>()<span class="op">+</span><span class="kw">theme_bw</span>()<span class="op">+</span><span class="kw">scale_color_gradientn</span>(<span class="dt">name=</span><span class="st">&quot;Sex&quot;</span>,<span class="dt">colours=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;#FFFF00&quot;</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">face=</span><span class="st">&quot;bold&quot;</span>,<span class="dt">size=</span><span class="dv">8</span>, <span class="dt">angle=</span><span class="dv">0</span>), <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">breaks=</span><span class="kw">sort</span>(<span class="kw">unique</span>(ice_res<span class="op">$</span>X)),
                   <span class="dt">labels=</span><span class="kw">as.character</span>(seku)) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Individual effect&quot;</span>)

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_ICE_5.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)

###############################################################################################################
<span class="co"># Interactions</span>
###############################################################################################################


it &lt;-<span class="st"> </span><span class="kw">interact</span> (<span class="dt">allsim =</span> simu[[<span class="dv">1</span>]], <span class="dt">dataset =</span> dtaset,<span class="dt">exposures =</span> Exposures,
                      <span class="dt">confounders =</span> <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>), <span class="dt">squem =</span> summary_table_lines)

knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(it))

pd &lt;-<span class="st"> </span><span class="kw">position_dodge</span>(<span class="fl">0.1</span>)
<span class="kw">ggplot</span>(it, <span class="kw">aes</span>(<span class="dt">x=</span>Interaction, <span class="dt">y=</span>Mean, <span class="dt">colour=</span>Interaction)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin=</span>Mean<span class="op">-</span>SD, <span class="dt">ymax=</span>Mean<span class="op">+</span>SD), <span class="dt">width=</span>.<span class="dv">1</span>, <span class="dt">position=</span>pd) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">position=</span>pd) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">position=</span>pd) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Estimated (Boostrapped 95% CI&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Interaction&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_flip</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Interaction&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) 

file_exp_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;Y&quot;</span>,h,<span class="st">&quot;_Inter.jpg&quot;</span>)

<span class="kw">ggsave</span>(file_exp_name)


time_doc3 &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()

<span class="kw">print</span>(time_doc3 <span class="op">-</span><span class="st"> </span>time_doc1)</code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
